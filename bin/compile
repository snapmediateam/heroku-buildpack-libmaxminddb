#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_FILE=$3

echo $BUILD_DIR
echo $CACHE_DIR
echo $ENV_FILE

VERSION="1.1.5"
LIBMAXMIND_DIST_FILE="libmaxminddb-$VERSION.tar.gz"

VENDORED_GEOIP="vendor/geoip/$GEOIP_VERSION"
APP_GEOIP="/app/$VENDORED_GEOIP"

LIBMAXMIND_DIST_URL="https://github.com/maxmind/libmaxminddb/releases/download/$VERSION/$LIBMAXMIND_DIST_FILE"

echo "Preparing directoryies: $CACHE_DIR/.geoip  $BUILD_DIR/$VENDORED_GEOIP"
cd
mkdir -p $CACHE_DIR/.geoip
mkdir -p "$BUILD_DIR/$VENDORED_GEOIP"
mkdir -p "$BUILD_DIR/$VENDORED_GEOIP/share/"

cd $CACHE_DIR/.geoip

echo "-----> Installing libmaxminddb $VERSION"

cd $CACHE_DIR/.geoip

if [ ! -d $CACHE_DIR/.geoip/libmaxminddb ]; then
  # Download and build libmaxminddb
  curl -s -L -o libmaxminddb-$VERSION.tar.gz $LIBMAXMIND_DIST_URL
  tar -zxvf libmaxminddb-$VERSION.tar.gz > /dev/null
  cd libmaxminddb-$VERSION
  ./configure --prefix="$CACHE_DIR/.geoip/libmaxminddb" > /dev/null
  make > /dev/null
  make check > /dev/null
  make install > /dev/null
else
  echo "$CACHE_DIR/.geoip/libmaxminddb already cached"
fi

# Copy libmaxminddb files to build dir
cp -R $CACHE_DIR/.geoip/libmaxminddb $BUILD_DIR/$VENDORED_GEOIP

LIBMAXMINDDB_PATH="$BUILD_DIR/$VENDORED_GEOIP"

export MAXMIND_BINARY=$LIBMAXMINDDB_PATH/bin/mmdblookup
export LD_LIBRARY_PATH=$LIBMAXMINDDB_PATH/lib

echo $MAXMIND_BINARY
echo $LD_LIBRARY_PATH

